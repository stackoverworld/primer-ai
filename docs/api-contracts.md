# API Contracts

- Last reviewed: 2026-02-16

## Contract-First Policy
- Define or update contracts before implementing integration behavior.
- Keep schema changes backward-compatible unless a migration is documented.
- Version externally consumed contracts.

## Initial Contract Surface
- CLI: `primer-ai init [path] [--provider auto|codex|claude] [--model <id>] [--format text|json] [options]` -> scaffolds project context with Codex-first defaults (Claude optional), optionally captures provider-specific model selection in interactive AI-assisted mode, supports migration in non-empty repositories only in `ai-assisted` mode, and treats `--force` as overwrite for conflicting scaffold paths instead of `.primer-ai.generated` conflict variants; exits `0` success, `1` operational failure, `2` user/config contract errors.
- CLI: `primer-ai fix [path] [--provider auto|codex|claude] [--model <id>] [--agent codex|claude|both] [--notes <text>] [--focus <text>] [--[no-]show-ai-file-ops] [--max-files <n>] [--max-passes <n>] [--ai-timeout-sec <seconds>] [--dry-run] [--format text|json] [-y|--yes]` -> scans repository context, infers verification commands from stack policy + package scripts + installed tooling, runs baseline verification, exits early when no actionable failures remain, and otherwise executes iterative AI fix passes with re-verification after each pass. When `--max-passes` is omitted, fix starts from pass budget `3` and can adaptively grow that budget up to safety cap `12` while actionable failures remain; explicit `--max-passes` is treated as hard cap. `--show-ai-file-ops` defaults to enabled and can be disabled with `--no-show-ai-file-ops`. Missing scripts/tools, lock-contention signals, and timed-out verification commands are treated as non-actionable skips to avoid stalled loops; exits `0` success, `1` operational failure, `2` user/config contract errors.
- CLI: `primer-ai refactor [path] [--provider auto|codex|claude] [--model <id>] [--planner-model <id>] [--orchestrator-model <id>] [--worker-model <id>] [--agent codex|claude|both] [--notes <text>] [--focus <text>] [--[no-]show-ai-file-ops] [--[no-]orchestration] [--max-subagents <n>] [--max-files <n>] [--max-passes <n>] [--ai-timeout-sec <seconds>] [--format text|json] [--[no-]resume] [--dry-run] [-y|--yes]` -> scans repository, composes deterministic refactor prompt, optionally asks for provider/model/log streaming/custom notes/orchestration choices in interactive mode, calibrates heuristic scan categories with AI classification, computes adaptive pass budget from calibrated backlog unless `--max-passes` is provided, and may raise that adaptive budget mid-run (up to the adaptive safety cap of `80`) when rescans report larger remaining backlog. It then runs multi-pass AI refactor loops with rescans (and AI recalibration) until backlog converges or pass cap is reached; exits early when no actionable backlog remains. Refactor execution persists checkpoint state in `.primer-ai/refactor-resume.json`, prompts whether to continue when an unfinished session exists (interactive mode), reuses saved execution settings on resume, and continues from the saved pass when `--resume` is enabled. `--ai-timeout-sec` controls per-subprocess AI execution timeout. `--show-ai-file-ops` defaults to enabled and can be disabled with `--no-show-ai-file-ops`; when enabled, console streaming emits compact file-operation events (`Read/Created/Updated/Deleted file`) while suppressing known noisy provider internals and prompt-echo boilerplate. On completion, CLI prints a deterministic run summary including final backlog and source-file change counts for the current invocation. Codex orchestration mode can run planner/orchestrator/worker role models with deterministic worker wave scheduling and file-scope ownership prompts; exit `0` success, `1` operational failure, `2` user/config contract errors.
- CLI: `primer-ai generate-logs [path] [--from <ref>] [--to <ref>] [--from-version <semver>] [--to-version <semver>] [--provider auto|codex|claude] [--agent codex|claude|both] [--model <id>] [--ai-timeout-sec <seconds>] [--[no-]show-ai-file-ops] [--output <path>] [--thanks <handle>] [--stdout] [--[no-]uncommitted] [--format text|json]` -> AI-generates release-note bullets from real git deltas and writes grouped version sections (`## from -> to`) with `### Changes` and `### Fixes` lists. New sections are prepended; rerunning the same range upserts that section. Empty sections are omitted (`### Fixes` is skipped when no fixes are generated). If both sections are empty, command reports no entries and leaves the file unchanged. Base range resolution is: explicit flags first, else latest `to` version from existing `RELEASE_LOG.md`, else latest GitHub tag on `origin`. Version flags are strict GitHub-tag mode: `--from-version` and `--to-version` must resolve to existing tags on `origin` (including prerelease matches like `v0.1.59-beta`), and generation fails when those versions are not present on GitHub tags. `--from`/`--to` accept standard git refs for non-version mode. Uncommitted working-tree deltas are included in ref mode by default, but auto-excluded in version mode for deterministic historical releases. `--thanks` is optional and only appends `Thanks @handle.` when provided; exits `0` success, `1` operational failure, `2` user/config contract errors.

## Planned (Not Yet Shipped)
- `primer-ai doctor`, `primer-ai check`, and `primer-ai run` are planned but not currently implemented.
- `src/lib` task-graph/config/reporting APIs are planned but not currently implemented.
- Structured JSON report envelopes (`version`, `timestamp`, `status`, `summary`, `details`) are planned for future command output modes.

## Error Model
- Provide stable machine-readable error codes.
- Separate user-safe messages from internal diagnostics.
- Track error classes and expected remediation in tests.

## Compatibility Rules
- Additive changes are preferred over breaking changes.
- Breaking changes require explicit versioning and migration notes.
- Reflect contract updates in tests and release notes.
